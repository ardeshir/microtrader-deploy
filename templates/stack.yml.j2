AWSTemplateFormatVersion: "2010-09-09"

Description: AWS CloudFormation 

Parameters:
  ApplicationDesiredCount:
    Type: Number
    Description: The Desired number of Application instances
    Default: 1
  ApplicationImageId:  
    Type: String
    Description: Amazon machine image ID
  ApplicationKeyName:
    Type: String 
    Description: EC2 Key pair for SSH 
  ApplicationInstanceType:
    Type: String 
    Description: Application Instance Type
    Defautl: t2.micro
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
  VpcName:
    Type: String
    Description: Name of the target VPC 
    Default: Default

    

Resources:
  ApplicationAutoscalingLaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration 
    Properties:
      ImageId:
        Ref: ApplicationImageId 
      InstanceType:
        Ref: ApplicationInstanceType
      KeyName:
        Ref: ApplicationKeyName 
      IamInstanceProfile:
        Ref: ApplicationAutoscalingInstanceProfile
      SecurityGroups:
        - Ref: ApplicationAutoscalingSecurityGroup 
      UserData:
        Fn::Base64: 
          Fn::Join: ["", [
           "#!/bin/bash\n",
           "/opt/aws/bin/cfn-init -v ",
           "    --stack ", { "Ref" : "AWS::StackName" },
           "    --resource ApplicationAutoscalingLaunchConfiguration ",
           "    --region ", { "Ref" : "AWS::Region" },
           "    --http-proxy ", "Fn::ImportValues": { "Fn::Sub": "${VpcName}ProxyUrl" },
           "    --https-proxy ", "Fn::ImportValues": { "Fn::Sub": "${VpcName}ProxyUrl" },           
           "\n",
           "/opt/aws/bin/cfn-signal -e $? --stack ", { "Ref" : "AWS::StackName" },
           "    --resource ApplicationAutoscaling ",
           "    --region ", { "Ref" : "AWS::Region" },
           "    --http-proxy ", "Fn::ImportValues": { "Fn::Sub": "${VpcName}ProxyUrl" },
           "    --https-proxy ", "Fn::ImportValues": { "Fn::Sub": "${VpcName}ProxyUrl" }, 
           "\n",
          ]]
  ApplicationAutoscaling:
    Type: AWS::AutoScaling::AutoScalingGroup
    CreationPolicy:
      ResourceSignal:
        Count::
          Ref: ApplicationDesiredCount
        Timeout: PT15M
    Properties:
      LaunchConfigurationName:
        Ref: ApplicationAutoscalingLaunchConfiguration 
      MinSize: 0
      MaxSize: 4
      VPCZoneIdentifier:
        - Fn::ImportValues:
            Fn::Sub: ${VpcName}MediumSubnetA
        - Fn::ImportValues:
            Fn::Sub: ${VpcName}MediumSubnetB
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${AWS::StackName}-ApplicationAutoscaling-instance 
          PropagateAtLaunch: "true"
        - Key: hazelcast:group
          Value:
            Ref: ApplicationCluster
          PropagateAtLaunch: "true"





  #StarterBucket{{ Stack.Inputs.MyStackInput }}:
    #Type: "AWS::S3::Bucket"
    #Properties:
      #BucketName:
        #Fn::Sub: ${AWS::AccountId}-starter-bucket-${MyStackInput}
      #Tags:
        #- Key: Name
          #Value: 
            #Fn::Sub: ${AWS::AccountId}-starter-bucket-${MyStackInput}